Рассмотрим как организованы бизнес-классы платформы Гедымин и как мы можем сопоставить им сущности платформы GDMN.

Напомним, что в терминах платформы Гедымин все объекты в базе данных делятся на две большие категории:

1. Справочники
2. Документы

Документ отличается от справочника следующим:

1. К нему могут быть привязаны бухгалтерские проводки и складское движение.
2. Все типы документов имеют одну базовую таблицу `GD_DOCUMENT`. Некоторые типы документов вообще не имеют никаких дополнительных таблиц и хранят все свои данные только в `GD_DOCUMENT`.
3. Документы бывают простыми (одна запись в `GD_DOCUMENT` и одна запись в присоединенной таблице) и сложными, состоящими из шапки и позиций. 
4. Каждая позиция тоже является документом, т.е. имеет свою отдельную запись в `GD_DOCUMENT`. Поле `PARENT` позиции указывает на запись документа шапки.

Документы в свою очередь подразделяются на четыре категории: стандартные документы, пользовательские документы, складские документы и прайс листы.

## Стандартные классы справочников

Иерархия стандартных бизнес-классов определена в исходном коде на Delphi. Общий предок для всех бизнес-классов -- абстрактный класс `TgdcBase`.

В простейшем случае данные бизнес-класса находятся в одной таблице. Её имя возвращает метод `GetListTable`. Единственное требование, предъявляемое к такой таблице -- первичный ключ из одного целочисленного поля с именем `ID`.

Бизнес-классы могут наследоваться. При этом их данные могут находиться как в одной таблице, так и в нескольких.

В случае одной таблицы существует некоторое поле **селектор**, значение которого может сказать нам к какому именно классу принадлежит конкретная запись.

Например, бизнес-классы `TgdcFolder` (Папка в справочнике контактов) и `TgdcGroup` (Группа контактов) хранят свои данные одной таблице `GD_CONTACT`. Только по значению поля `CONTACTTYPE` мы можем сказать, что запись относится к тому или иному классу.

Другой способ организации данных при наследовании бизнес-классов -- отдельная таблица со следующей структурой:

1. Первичный ключ из одного целочисленного поля.
2. Первичный ключ одновременно является внешним ключем на таблицу родительского класса.

Обратите внимание, что для _стандартных_ бизнес-классов нет особых требований к имени поля первичного ключа наследника.

Такая отдельная таблица для наследника в терминах платформы Гедымин называется **distinct relation**.

Если есть несколько бизнес-классов, основанных на одной таблице, то в платформе Гедымин вводится общий базовый класс. Он служит для отображения всего набора данных и для определения (через метод `GetCurrRecordClass`) бизнес-класса конкретной записи.

Например, данные для людей, организаций и банков в базе данных хранятся в следующих таблицах:

* Физическое лицо: `GD_CONTACT - GD_PEOPLE`
* Организация: `GD_CONTACT - GD_COMPANY`
* Банк: `GD_CONTACT - GD_COMPANY - GD_BANK`

Соответствующая иерархия бизнес-классов выглядит следующим образом:

```
                         TgdcBase
                             |
                      TgdcBaseContact
                       /           \
                 TgdcContact    TgdcCompany
                                    |
                                 TgdcBank          

```

Если мы создадим экземпляр класса `TgdcBaseContact` и откроем его набор данных, то увидим на экране содержимое таблицы `GD_CONTACT` как наиболее общей для всех указанных классов.

Когда мы захотим открыть на редактирование конкретную запись:

1. сначала будет выполнен метод `GetCurrRecordClass`, который вернет нам точный класс этой записи.
2. будет создан экземпляр полученного класса.
3. с его помощью открыт набор данных из одной строки для известного ИД записи. 

В дополнение стоит сказать, что некоторые необязательные атрибуты бизнес-класса могут быть вынесены в отдельную таблицу. Такая таблица не является классобразующей и служит исключительно для нормальзации структуры базы данных. В терминах платформы GDMN это **weak relation**.

## Стандартные классы документов

В Гедымине всего несколько стандартных классов для документов. В основном, все типы документов создаются уже в рамках платформы.

## Импорт стандартных бизнес-классов

Иерархия стандартных бизнес-классов выгружается из платформы Гедымин в виде JSON файла, на основании которого внутри GDMN создаются соответствующие одноименные сущности.

Связь между сущностью, её таблицами, именами полей, значениями селектора хранится в специальном объекте -- **адаптере**.

## Пользовательские справочники

Данные пользовательского справочника находятся в одной таблице. Её имя должно начинаться с префикса `USR$`, а первичный ключ состоять из одного целочисленного поля `ID`.

Справочники могут наследоваться. Для наследованного класса создается отдельная таблица первичный ключ которой должен называться `INHERITEDKEY` и одновременно являться внешним ключем на таблицу родительского бизнес-класса.

В платформе GDMN сущности для пользовательских справочников создаются при подключении к базе данных на основании анализа её структуры.

## Пользовательские документы

Для документов гораздо чаще чем для справочников встречается ситуация, когда на одних и тех же таблицах основаны разные классы (сущности в терминах GDMN). Селектором типа в таком случае выступает поле `DOCUMENTTYPEKEY` таблицы `GD_DOCUMENT`.

Все документы имеют одного общего предка `TgdcDocument`.

Вся информация о типах документов, включая их иерархию наследования, находится в таблице `GD_DOCUMENTTYPE`.

Рассмотрим таблицы простого пользовательского документа:

```
GD_DOCUMENT  <--- ID = DOCUMENTKEY ------ USR$DOC_TABLE
```

Т.е. таблица пользовательского документа должна иметь поле первичный ключ с именем `DOCUMENTKEY`, которое ссылается на таблицу `GD_DOCUMENT`.

Сложный пользовательский документ:

```
GD_DOCUMENT  <--- ID = DOCUMENTKEY ------ USR$DOC_TABLE
     ^                                          ^
     |                                    DOCUMENTKEY = MASTERDOCKEY       
     |                                          |
     +------ ID = DOCUMENTKEY ----------- USR$DOC_POS_TABLE
         PARENT = ID of master doc
```

Обратите внимание, что связь между позициями документа и его шапкой мы можем установить как через поле `PARENT` в таблице `GD_DOCUMENT`, так и через поле `MASTERDOCKEY` в таблице позиций документа.

Для сложных документов внутри платформы создаются по два класса: один для шапки и один для позиции.

Обратите внимание, что одна и та же таблица может хранить записи разных типов документов, как связанных между собой наследованием, так и нет.

Например, пусть в базе есть таблица документа `USR$SOME_DOC`, тогда на ней может быть основана такая иерархия бизнес-классов:
```
                      TgdcDocument
                     /     |      \
           TgdcSomeDoc  TgdcDoc2  TgdcDoc3
                           |            |
                    TgdcDoc2Child    TgdcDoc3Child
                                        |
                                     TgdcDoc3SubChild   

```
Поле первичного ключа для таблицы документа **всегда** называется `DOCUMENTKEY`. Даже для наследованных документов.

Так как ИД типа документа 

Приведем иерархию базовых бизнес-классов документов платформы Гедымин:
```

                                   TgdcInvDocument
                                  /
               TgdcInvBaseDocument                 
              /                   \ 
             /                     TgdcInvDocumentLine
            / 
           /
          /                               TgdcUserDocument 
         /                               /
TgdcDocument ------- TgdcUserBaseDocument                                  
        \                                \
         \                                TgdcUserDocumentLine
          \                         
           \   
            \                      TgdcInvPriceList
             \                    / 
              TgdcInvBasePriceList 
                                  \
                                   TgdcInvPriceListLine
```